<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <!-- for live debug -->
    <!-- <meta http-equiv="refresh" content="10" > -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0 user-scalable=no" >
    <meta name="viewport" content="width=device-width, user-scalable=no" />
    <meta charset="utf-8">

    <title>Var Separator</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Ubuntu&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://kit.fontawesome.com/965196d787.js" crossorigin="anonymous"></script>
    
</head>

<body>
    <div class="container-fluid">
        <section id="title">
            <h1>麻将积分助手</h1>
        </section>
        
        <div class="container" id="main">
            <!-- setting buttons -->
            <div class="row row-cols-2">
                <div class="col">
                    <button class="btn btn-danger mr-auto" id="delete-btn">删除记录</button>
                </div>
                <div class="col">
                    <button class="btn btn-dark mr-auto" id="edit-btn">编辑玩家</button>
                </div>
            </div>
            <!-- players and table -->
            <div class="row row-cols-3">
                <span class="col"></span>
                <button class="col player btn" id="up" data-bs-toggle="modal" data-bs-target="#recordModal" seat="">
                    <i class="fas fa-user-circle player-icon"></i>
                    <span class="player-name" id="up-name">111</span>
                    <span class="player-score" id="up-score">111</span>
                </button>
                <span class="col"></span>
                <button class="col player btn" id="left" data-bs-toggle="modal" data-bs-target="#recordModal" seat="">
                    <i class="fas fa-user-circle player-icon"></i>
                    <span class="player-name" id="left-name">222</span>
                    <span class="player-score" id="left-score">222</span>
                </button>
                <button class="col game-table btn" id="middle">
                    <i class="fas fa-square"></i></button>
                <button class="col player btn" id="right" data-bs-toggle="modal" data-bs-target="#recordModal" seat="">
                    <i class="fas fa-user-circle player-icon"></i>
                    <span class="player-name" id="right-name">333</span>
                    <span class="player-score" id="right-score">333</span>
                </button>
                <span class="col"></span>
                <button class="col player btn" id="down" data-bs-toggle="modal" data-bs-target="#recordModal" seat="">
                    <i class="fas fa-user-circle player-icon"></i>
                    <span class="player-name" id="down-name">444</span>
                    <span class="player-score" id="down-score">444</span>
                </button>
                <span class="col"></span>
            </div>
            <div class="modal fade" id="changeNameModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" >
                    <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">New message</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                        <div class="mb-3">
                            <label for="recipient-name" class="col-form-label">Player Name:</label>
                            <input type="text" class="form-control" id="player-name" name="fname">
                        </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button id="btn-change-name" type="button" class="btn btn-primary" data-bs-dismiss="modal">Change Name</button>
                    </div>
                    </div>
                </div>
            </div>
            
            <div class="modal fade" id="recordModal" tabindex="-1" aria-labelledby="recordModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" >
                    <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="recordModalLabel">Record</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form class="container">
                            <div class="row">
                                <span class="secton-title">牌型:</span>
                            </div>
                            <div class="row">
                                <div class="col col-12" id="total-hu">
                                    <span class="badge bg-danger" id="th-lb">天胡</span>
                                    <span class="badge bg-warning" id="dh-lb">地胡</span>
                                    <span class="badge bg-info" id="qxd-lb">七小对</span>
                                    <span class="badge bg-info" id="ytl-lb">一条龙</span>
                                    <span class="badge bg-info" id="qys-lb">清一色</span>
                                    <span class="badge bg-success" id="ddh-lb">对对胡</span>
                                    <span class="badge bg-secondary" id="hu-lb">小屁胡</span>
                                    <span class="badge bg-dark" id="zimo-lb">自摸</span>
                                    <span class="badge bg-dark" id="zhuang-lb">庄家</span>
                                    <span class="badge bg-dark" id="qyj-lb">去幺九</span>
                                </div>
                            </div>
                            <div class="row">
                                <span class="col secton-title">胡谁？</span>
                            </div>
                            <div class="row">
                                    <div class="col">
                                        <input class="form-check-input target-check record-check" type="checkbox" name="t1" id="t1">
                                        <label class="form-check-label target-name" for="t1" id="t1-name">P1</label>
                                    </div>
                                    <div class="col">
                                        <input class="form-check-input target-check record-check" type="checkbox" name="t2" id="t2">
                                        <label class="form-check-label target-name" for="t2" id="t2-name">P2</label>
                                    </div>
                                    <div class="col">
                                        <input class="form-check-input target-check record-check" type="checkbox" name="t3" id="t3">
                                        <label class="form-check-label target-name" for="t3" id="t3-name">P3</label>
                                    </div>
                            </div>
                            </form>
                            <br>
                            <div class="row row-cols-3">
                                <div class="col">
                                    <input class="form-check-input hu-check record-check hu-type" type="checkbox" name="hu" id="hu" checked>
                                    <label class="form-check-label record-check-name" for="hu">小屁胡</label>
                                </div>
                                <div class="col">
                                    <input class="form-check-input hu-check record-check hu-type" type="checkbox" name="ddh" id="ddh">
                                    <label class="form-check-label record-check-name" for="ddh">对对胡</label>
                                </div>
                                <div class="col">
                                    <input class="form-check-input hu-check record-check hu-type" type="checkbox" name="qys" id="qys">
                                    <label class="form-check-label record-check-name" for="qys">清一色</label>
                                </div>
                                <div class="col">
                                    <input class="form-check-input hu-check record-check hu-type" type="checkbox" name="ytl" id="ytl">
                                    <label class="form-check-label record-check-name" for="ytl">一条龙</label>
                                </div>
                                <div class="col">
                                    <input class="form-check-input hu-check record-check hu-type" type="checkbox" name="qxd" id="qxd">
                                    <label class="form-check-label record-check-name" for="qxd">七小对</label>
                                </div>
                                <div class="col">
                                    <input class="form-check-input hu-check record-check hu-type" type="checkbox" name="dh" id="dh">
                                    <label class="form-check-label record-check-name" for="dh">地胡</label>
                                </div>
                                <div class="col">
                                    <input class="form-check-input hu-check record-check hu-type" type="checkbox" name="th" id="th">
                                    <label class="form-check-label record-check-name" for="th">天胡</label>
                                </div>
                            </div>
                            <br />
                            <div class="row row-cols-3">
                                <div class="col">
                                    <button class="btn btn-secondary fan-btn" name="minus-fan" type="button">减一杠</button>
                                </div>
                                <div class="col">
                                    <button class="btn btn-secondary fan-btn" name="plus-fan" type="button">加一杠</button>
                                </div>
                                <div class="col">共<span id="fan-value">0</span>杠</div>
                            </div>
                            <br />
                            <div class="row row-cols-3">
                                <div class="col">
                                    <input class="form-check-input hu-check record-check" type="checkbox" name="zimo" id="zimo">
                                    <label class="form-check-label record-check-name" for="zimo">自摸</label>
                                </div>
                                <div class="col"></div>
                                <div class="col">加<span id="zimo-value">0</span>番</div>
                            </div>
                            <br />
                            <div class="row row-cols-3">
                                <div class="col">
                                    <input class="form-check-input hu-check record-check" type="checkbox" name="zhuang" id="zhuang">
                                    <label class="form-check-label record-check-name" for="zhuang">我是庄家</label>
                                </div>
                                <div class="col"></div>
                                <div class="col">加<span id="zhuang-value">0</span>番</div>
                            </div>
                            <div class="row">
                                    
                                    
                                <div class="col">
                                    <input class="form-check-input zhuang-check record-check" type="radio" name="z" key="">
                                    <label class="form-check-label zhuang-name" for="z">
                                      Default radio
                                    </label>
                                </div>
                                <div class="col">
                                    <input class="form-check-input zhuang-check record-check" type="radio" name="z" key="">
                                    <label class="form-check-label zhuang-name" for="z">
                                      Default checked radio
                                    </label>
                                </div>
                                <div class="col">
                                    <input class="form-check-input zhuang-check record-check" type="radio" name="z" key="">
                                    <label class="form-check-label zhuang-name" for="z">P3</label>
                                </div>
                            </div>
                            <br />
                            <div class="row row-cols-3">
                                <div class="col">
                                    <input class="form-check-input hu-check record-check" type="checkbox" name="qyj" id="qyj">
                                    <label class="form-check-label record-check-name" for="qyj">去幺九</label>
                                </div>
                                <div class="col"></div>
                                <div class="col">加<span id="qyj-value">0</span>番</div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button id="btn-record" type="button" class="btn btn-primary" data-bs-dismiss="modal">记分</button>
                    </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="content"><h2>History:</h2></div>
        <ul class="list-group list-group-flush" id="history">
          </ul>
        <section id="footer">
            Made by @ Victor Zhang 🤓 2021
        </section>
    </div>
    <script type="text/javascript" src="https://livejs.com/live.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script type="text/javascript">
        var number = 0
        var fName = "favicon-animation/frame_0" + number + "_delay-0.05s.gif"

        setInterval(function() {
            if (number == 11) {
                number = 0
            }

            var fName = "favicon-animation/frame_0" + number + "_delay-0.05s.gif"
            $("link[rel='icon']").remove();
            $("link[rel='shortcut icon']").remove();
            $("head").append('<link rel="icon" href="' + fName + '" type="image/gif">');
            number++
        }, 1000);
        selected_player = ""
        new_name = ""
        
        total_fan = 0
        hu_fan = 1
        fan = 0
        zhuang_fan = 0
        zimo_fan = 0
        qyj_fan = 0
        fan_rules = {
            "hu":1,
            "qys":3,
            "ytl":3,
            "ddh":2,
            "qxd":3,
            "dh":5,
            "th":6,
            "zimo":1,
            "zhuang":1,
            "qyj":1,
        }
        id2chinese = {
            "th":"天胡",
            "dh":"地胡",
            "qxd":"七小对",
            "ytl":"一条龙",
            "qys":"清一色",
            "ddh":"对对胡",
            "hu":"小屁胡",
            "zimo":"自摸",
            "zhuang":"庄家",
            "qyj":"去幺九",
        }
        record = ""
        targets = ""
        targets_zhuang = ""
        
        player_names = {"up":"上","left":"左","right":"右","down":"下"}
        var names = localStorage.getItem('names');
        if (!(names===null)){
            player_names = JSON.parse(names)
            localStorage.setItem("names", JSON.stringify(player_names));
        }

        history_record = {}
        for (const key in player_names) {
            history_record[key] = []
        }
        var array = localStorage.getItem('history');
        if (!(array===null)){
            history_record = JSON.parse(array)
            localStorage.setItem("history", JSON.stringify(history_record));
        }

        var changeNameModal = document.getElementById('changeNameModal')
        changeNameModal.addEventListener('show.bs.modal', function (event) {
            // Button that triggered the modal
            var button = event.relatedTarget
            // Extract info from data-bs-* attributes
            var recipient = button.getAttribute('seat')
            var recipient = player_names[button.getAttribute("id")]
            // If necessary, you could initiate an AJAX request here
            // and then do the updating in a callback.
            //
            // Update the modal's content.
            var modalTitle = changeNameModal.querySelector('.modal-title')
            var modalBodyInput = changeNameModal.querySelector('.modal-body input')

            modalTitle.textContent = 'Change Name for ' + recipient
            modalBodyInput.value = recipient
            selected_player = $(button).attr("id")
        })

        var changeNameModal = document.getElementById('recordModal')
        changeNameModal.addEventListener('show.bs.modal', function (event) {
            // Button that triggered the modal
            var button = event.relatedTarget

            selected_player = $(button).attr("id")
            setTotalFan()
            
        })

        
        function setTotalFan() {
            // total_fan = fan+hu_fan+zimo_fan+zhuang_fan
            total_fan = fan
            record = ""
            $(".hu-check").map(function(){
                if ($(this).prop("checked")){
                    // if i am zhuang, no need to choose others
                    if($(this).attr("id")=="zhuang") {
                        $(".zhuang-check").hide()
                        $(".zhuang-check").prop("checked",false)
                        $(".zhuang-name").hide()
                    }
                    $("#"+$(this).attr("id")+"-lb").show()
                    record+=$(this).attr("id")+","
                    total_fan+=fan_rules[$(this).attr("id")]
                }else{
                    if($(this).attr("id")=="zhuang") {
                        $(".zhuang-check").show()
                        $(".zhuang-name").show()
                    }
                    $("#"+$(this).attr("id")+"-lb").hide()
                }
            })
            changeNameModal.querySelector('.modal-title').textContent = 'Record for ' + player_names[selected_player] + ", 合计：" + total_fan + "番"
        }

        function setFan(v) {
            fan = v
            $("#fan-value").text(fan)
            setTotalFan()
        }
        function setHuFan(hu_list) {
            hu_fan = 0
            hu_list.forEach(each => {
                hu_fan+=fan_rules[each]
            });
            setTotalFan()
        }
        function setZimoFan(v) {
            zimo_fan = v
            $("#zimo-value").text(zimo_fan)
            setTotalFan()
        }

        function setZhuangFan(v) {
            zhuang_fan = v
            $("#zhuang-value").text(zhuang_fan)
            setTotalFan()
        }

        function setQyjFan(v) {
            qyj_fan = v
            $("#qyj-value").text(qyj_fan)
            setTotalFan()
        }

        function resetAllFan() {
            fan = 0
            $("#fan-value").text(fan)
            $(".hu-check").map(function(){
                if ($(this).attr("id")!="hu"){
                    $(this).prop("checked",false)
                }else{
                    $(this).prop("checked",true)
                }
            })
            zimo_fan = 0
            $("#zimo-value").text(zimo_fan)
            zhuang_fan = 0
            $("#zhuang-value").text(zhuang_fan)
            setTotalFan()
        }

        function saveNames() {
            localStorage.setItem("names", JSON.stringify(player_names));
        }

        function saveRecord() {
            if (record!="") {
                targets.split(",").forEach(each => {
                    if (each!="") {
                        history_record[selected_player].push(each+":"+Date.now()+":"+record+":"+selected_player+":"+"-"+":"+fan)
                    }
                });
                history_record[selected_player].push(selected_player+":"+Date.now()+":"+record+":"+targets+":"+"+"+":"+fan)
                localStorage.setItem("history", JSON.stringify(history_record));
            }else{
                localStorage.setItem("history", JSON.stringify(history_record));
            }
        }
        function deleteHistory() {
            history_record={}
            for (const key in player_names) {
                history_record[key] = []
            }
            saveRecord()
            $("#history").empty()
        }
        function showHistory() {
            // <li class="list-group-item">An item</li>
            all_record = []
            for (const key in history_record) {
                all_record = all_record.concat(history_record[key])
            }
            all_record.sort(function(a, b){return parseInt(b.split(":")[1])-parseInt(a.split(":")[1])});
            $("#history").empty()

            overall_points = {"up":0,"left":0,"right":0,"down":0,}
            all_record.forEach(each => {
                total_points = 0
                chinese_hu = ""
                fields = each.split(":")

                total = parseInt(fields[5])
                
                fields[2].split(",").forEach(each => {
                    if (each!="") {
                        total+=fan_rules[each]
                        chinese_hu+=id2chinese[each]+" "
                    }
                });
                
                n_key = fields[0]
                if(fields[4]=="-"){ // if loose
                    if(fields[0].slice(-1)=="*"){
                        total_points = -Math.pow(2,total+1-1)
                        n_key = fields[0].slice(0,-1)
                    }
                    else total_points = -Math.pow(2,total-1)
                    
                } else{ // if win
                    fields[3].split(",").forEach(each => {
                        if (each!="") {
                            if (each.slice(-1)=="*"){
                                total_points+=Math.pow(2,(total+1)-1)
                            }else{
                                total_points+=Math.pow(2,total-1)
                            }
                        }
                    });
                }
                // pow = (Math.abs(total_points)-1<0)?0:Math.abs(total_points)-1
                overall_points[n_key]+=total_points
                if (total_points>0){
                    $("#history").append("<li class='list-group-item'>"+player_names[n_key]+"  赢"+chinese_hu+": "+total_points+"分</li>")
                }else{
                    $("#history").append("<li class='list-group-item'>"+player_names[n_key]+"  输"+chinese_hu+": "+total_points+"分</li>")
                }
            });
            for (const key in overall_points) {
                $("#"+key+"-score").text(overall_points[key])
            }
        }
        showHistory()
        
        

        $(document).ready(function() {
            wid = $(".player").width()
            $(".player, .game-table").height(wid)
            $(".player, .game-table").css({"font-size":wid*0.7})
            $(".player-name").css({"padding":wid*0.2,})
            $(".hu-label, .fan-btn").css({"min-width":"100px"})

            
            player_key_list = $(".player").map(function () {
                return $(this).attr("id")
            })
            for (let i = 0; i < player_key_list.length; i++) {
                n = player_names[player_key_list[i]]
                $("#"+player_key_list[i]+"-name").text(n)
                
            }

            $("#edit-btn").click(function() {
                // ################################################
                // buttons for player icon
                // ################################################
                class_str = $(".player-icon").attr("class")
                // go to edit mode
                if (class_str.includes("fa-user-circle")){
                    $(".player-icon").removeClass("fa-user-circle")
                    $(".player-icon").addClass("fa-user-edit")
                    $("#edit-btn").text("完成")
                    $(".player").css({"color":"#E59934"})
                    $(".player").map(function () {
                        $(this).attr("data-bs-target","#changeNameModal")
                    })
                }else{ // go back to normal mode
                    $(".player-icon").removeClass("fa-user-edit")
                    $(".player-icon").addClass("fa-user-circle")
                    $("#edit-btn").text("编辑玩家")
                    $(".player").css({"color":"black"})
                    $(".player").map(function () {
                        $(this).attr("data-bs-target","#recordModal")
                    })
                    // $(".player").attr("data-bs-target","#changeNameModal")
                }
            })
            $("#delete-btn").click(function() {
                deleteHistory()
                overall_points = {"up":0,"left":0,"right":0,"down":0,}
                for (const key in overall_points) {
                $("#"+key+"-score").text(overall_points[key])
            }
            })
            
            $(".player").click(function() {
                // ################################################
                // buttons for player icon
                // ################################################
                selected_player = $(this).attr("id")
                
                if ($(".player-icon").attr("class").includes("fa-user-circle")){
                    resetAllFan()
                    ind = 0
                    zhuang_names = $(".zhuang-name")
                    for (const key in player_names) {
                        if (key!=selected_player) {
                            $("#t"+(ind+1)).attr("name",key)
                            $(".target-name").eq(ind).text(player_names[key])
                            $("#z"+(ind+1)).attr("name",key)
                            $(".zhuang-check").eq(ind).attr("key",key)
                            $(".zhuang-name").eq(ind).text(player_names[key])
                            ind++
                        }
                    }
                }else{
                    new_name = ""
                    $("#player-name").val(new_name)
                    $("#player-name").focus()
                }
            })

            $("#btn-change-name").click(function(){
                if (selected_player!="") {
                    player_names[selected_player] = $("#player-name").val()
                    $("#"+selected_player+"-name").text(player_names[selected_player])
                    saveNames()
                }
            })
            $("#btn-record").click(function(){
                if (selected_player!="") {
                    saveRecord()
                    showHistory()

                }
            })

            $("#player-name").change(function () {
                player_key = $(this).attr("id")
                new_name = $(this).val()
            })
            $("#player-name").click(function () {
                $(this).select()
            })

            $(".hu-check").on("input proportychange", function () {
                hu_checked = $(".hu-check, #hu").prop("checked")
                bigger_hu_checked = $(this).attr("id")!="hu" && $(this).hasClass("hu-type")
                
                if (hu_checked && $(this).attr("id")=="hu"){
                    $(".hu-check").map(function(){
                        if ($(this).attr("id")!="hu"){
                            $(this).prop("checked",false)
                        }
                    })
                }
                if (bigger_hu_checked ){
                    $("#hu").prop("checked",false)
                }

                hu_list = $(".hu-check").map(function(){
                    if ($(this).prop("checked")){
                        return $(this).attr("id")
                    }
                }).get()
                setHuFan(hu_list)
            })
            // select target player
            $(".target-check").on("input proportychange", function () {
                targets = $(".target-check").map(function(){
                    if ($(this).prop("checked")){
                        return $(this).attr("name")
                    }
                }).get().toString()
            })
            // select target zhuang player
            $(".zhuang-check").on("input proportychange", function () {
                targets_zhuang = $(this).attr("key")
                targets = $(".target-check").map(function(){
                    console.log($(this).attr("name"));
                    if ($(this).prop("checked")&&($(this).attr("name")==targets_zhuang)){
                        return $(this).attr("name")+"*"
                    }else if($(this).prop("checked")){
                        return $(this).attr("name")
                    }
                }).get().toString()
            })

            $(".fan-btn").click(function () {
                if ($(this).attr("name")=="minus-fan"){
                    fan--
                    if (fan<0) fan=0
                }else{
                    fan++
                }
                setFan(fan)
            })

            $("#zimo").on("input proportychange", function () {
                v = ($(this).prop("checked"))?1:0
                setZimoFan(v)
            })

            $("#zhuang").on("input proportychange", function () {
                v = ($(this).prop("checked"))?1:0
                setZhuangFan(v)
            })

            $("#qyj").on("input proportychange", function () {
                v = ($(this).prop("checked"))?1:0
                setQyjFan(v)
            })
        })
    </script>
</body>

</html>
