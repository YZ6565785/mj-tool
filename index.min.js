function resetAllFan(){$("#fan-value").text(fan),$(".record-check").prop("checked",!1),$(".hu-check").map(function(){"hu"!=$(this).attr("id")?$(this).prop("checked",!1):$(this).prop("checked",!0)}),$("#zimo-value").text(zimo_fan),$("#zhuang-value").text(zhuang_fan),setTotalFan(recordModal,player_names,fan_rules,selected_player,fan)}function doneAndClear(){selected_player="",new_name="",total_fan=0,hu_fan=1,fan=0,zhuang_fan=0,zimo_fan=0,qyj_fan=0,record="",targets="",targets_zhuang="",gang_left="",gang_right=[],zhuang="",resetAllFan()}selected_player="",new_name="",total_fan=0,hu_fan=1,fan=0,zhuang_fan=0,zimo_fan=0,qyj_fan=0,fan_rules={hu:1,qys:3,ytl:3,ddh:2,qxd:3,dh:5,th:6,zimo:1,zhuang:1,qyj:1,g:1,jgd:3},id2chinese={th:"天胡",dh:"地胡",qxd:"七小对",ytl:"一条龙",qys:"清一色",ddh:"对对胡",hu:"小屁胡",zimo:"自摸",zhuang:"庄家",qyj:"去幺九",qyj:"去幺九",g:"杠",jgd:"金钩钓"},record="",targets="",targets_zhuang="",gang_left="",gang_right=[],zhuang="",player_names={up:"上",left:"左",right:"右",down:"下"};var array,names=localStorage.getItem("names");function setFan(e){fan=e,$("#fan-value").text(fan)}function setHuFan(e,t){hu_fan=0,t.forEach(t=>{hu_fan+=e[t]})}function setZimoFan(e){zimo_fan=e,$("#zimo-value").text(zimo_fan)}function setZhuangFan(e){zhuang_fan=e,$("#zhuang-value").text(zhuang_fan)}function setQyjFan(e){qyj_fan=e,$("#qyj-value").text(qyj_fan)}function setTotalFan(e,t,a,n,r){total_fan=r,record="",$(".hu-check").map(function(){$(this).prop("checked")?("zhuang"==$(this).attr("id")&&($(".zhuang-check").hide(),$(".zhuang-check").prop("checked",!1),$(".zhuang-name").hide()),$("#"+$(this).attr("id")+"-lb").show(),record+=$(this).attr("id")+",",total_fan+=a[$(this).attr("id")]):("zhuang"==$(this).attr("id")&&($(".zhuang-check").show(),$(".zhuang-name").show()),$("#"+$(this).attr("id")+"-lb").hide()),$("#zhuang-lb").text(""),$("#zhuang-lb").hide()}),e.querySelector(".modal-title").textContent="为 "+t[n]+"记分, 合计："+total_fan+"番"}function saveRecord(){""!=record?(time_now=Date.now(),targets.split(",").forEach(e=>{""!=e&&history_record.push(e+":"+time_now+":"+record+":"+selected_player+":-:"+fan)}),history_record.push(selected_player+":"+time_now+":"+record+":"+targets+":+:"+fan),localStorage.setItem("history",JSON.stringify(history_record))):localStorage.setItem("history",JSON.stringify(history_record))}function saveZhuangRecord(){time_now=Date.now(),gang_left==zhuang&&(record+="zhuang,"),gang_right.forEach(e=>{e==zhuang&&(e+="*"),history_record.push(e+":"+time_now+":"+record+":"+gang_left+":-:0")}),targets="",gang_right.forEach(e=>{e==zhuang?targets+=e+"*,":targets+=e+","}),history_record.push(gang_left+":"+time_now+":"+record+":"+targets+":+:0"),localStorage.setItem("history",JSON.stringify(history_record))}function saveSettings(){localStorage.setItem("settings",JSON.stringify(settings))}null!==names&&(player_names=JSON.parse(names),localStorage.setItem("names",JSON.stringify(player_names))),history_record=[],null!==(array=localStorage.getItem("history"))&&(history_record=JSON.parse(array),Array.isArray(history_record)||(history_record=[]),localStorage.setItem("history",JSON.stringify(history_record))),settings={"max-limit":8},null!==(array=localStorage.getItem("settings"))&&(settings=JSON.parse(array),localStorage.setItem("settings",JSON.stringify(settings))),showMaxLimit(settings["max-limit"]),showHistory(history_record,fan_rules,id2chinese,settings);var changeNameModal=document.getElementById("changeNameModal");changeNameModal.addEventListener("show.bs.modal",function(e){var t=e.relatedTarget,a=t.getAttribute("seat"),n=(a=player_names[t.getAttribute("id")],changeNameModal.querySelector(".modal-title")),r=changeNameModal.querySelector(".modal-body input");n.textContent="Change Name for "+a,r.value=a,selected_player=$(t).attr("id")});var recordModal=document.getElementById("recordModal");function showAlert(e){$("#alert-msg").text(e),$("#alertModal").addClass("show"),$("#alertModal").css({display:"block"})}function closeAlert(){$("#alertModal").removeClass("show"),$("#alertModal").css({display:"none"})}recordModal.addEventListener("show.bs.modal",function(e){var t=e.relatedTarget;selected_player=$(t).attr("id"),setTotalFan(recordModal,player_names,fan_rules,selected_player,fan)}),$(document).ready(function(){$("#btn-change-name").click(function(){""!=selected_player&&(player_names[selected_player]=$("#player-name").val(),$("#"+selected_player+"-name").text(player_names[selected_player]),saveNames(player_names))}),$(".alert-close").click(function(){closeAlert()}),$(".hu-check, .zhuang-check").on("input proportychange",function(){""==targets&&showAlert("请先选胡谁！"),hu_checked=$(".hu-check, #hu").prop("checked"),bigger_hu_checked="hu"!=$(this).attr("id")&&$(this).hasClass("hu-type"),"ddh"==$(this).attr("id")&&$(this).prop("checked")&&$("#jgd").prop("checked",!1),"jgd"==$(this).attr("id")&&$(this).prop("checked")&&$("#ddh").prop("checked",!1),hu_checked&&"hu"==$(this).attr("id")&&$(".hu-check").map(function(){"hu"!=$(this).attr("id")&&$(this).prop("checked",!1)}),bigger_hu_checked&&$("#hu").prop("checked",!1),hu_list=$(".hu-check").map(function(){if($(this).prop("checked"))return $(this).attr("id")}).get(),setHuFan(fan_rules,hu_list),setTotalFan(recordModal,player_names,fan_rules,selected_player,fan)}),$(".fan-btn").click(function(){"minus-fan"==$(this).attr("name")?(fan--,fan<0&&(fan=0)):fan++,setFan(fan),setTotalFan(recordModal,player_names,fan_rules,selected_player,fan)}),$("#zimo").on("input proportychange",function(){v=$(this).prop("checked")?1:0,setZimoFan(v),setTotalFan(recordModal,player_names,fan_rules,selected_player,fan)}),$("#zhuang").on("input proportychange",function(){v=$(this).prop("checked")?1:0,1==v&&($("#target-zhuang-lb").text(""),$("#target-zhuang-lb").hide()),setZhuangFan(v),setTotalFan(recordModal,player_names,fan_rules,selected_player,fan)}),$("#qyj").on("input proportychange",function(){v=$(this).prop("checked")?1:0,setQyjFan(v),setTotalFan(recordModal,player_names,fan_rules,selected_player,fan)}),$(".game-table").click(function(){gang_left="",gang_right=[],zhuang="",$(".gang-left").prop("checked",!1),$(".gang-right").prop("checked",!1),$(".gang-zhuang").prop("checked",!1);let e=0;for(const t in player_names)$(".gang-left-name").eq(e).text(player_names[t]),$(".gang-right-name").eq(e).text(player_names[t]),$(".gang-zhuang-name").eq(e).text(player_names[t]),e++}),$(".gang-left, .gang-right, .gang-zhuang").on("input proportychange",function(){which_name=$(this).attr("name"),key=$(this).attr("id").split("-")[2],"g-left"==which_name&&(gang_left=key),"g-right"==which_name&&(gang_right=[],$(".gang-right").map(function(){$(this).prop("checked")&&gang_right.push($(this).attr("id").split("-")[2])})),"g-zhuang"==which_name&&(zhuang=key),record="g,"}),$(".player").click(function(){if(selected_player=$(this).attr("id"),$(".player-icon").attr("class").includes("fa-user-circle")){setTotalFan(recordModal,player_names,fan_rules,selected_player,fan),ind=0,zhuang_names=$(".zhuang-name");for(const e in player_names)e!=selected_player&&($("#t"+(ind+1)).attr("name",e),$(".target-name").eq(ind).text(player_names[e]),$("#z"+(ind+1)).attr("name",e),$(".zhuang-check").eq(ind).attr("key",e),$(".zhuang-name").eq(ind).text(player_names[e]+"是庄"),ind++)}else new_name="",$("#player-name").val(new_name),$("#player-name").focus();$(".target-check").on("input proportychange",function(){$("#target-zhuang-lb").text(""),$("#target-zhuang-lb").hide(),$(".zhuang-check").map(function(){console.log($(this).attr("key")),$(this).prop("checked")&&(targets_zhuang=$(this).attr("key"))}),targets=$(".target-check").map(function(){return $(this).prop("checked")&&$(this).attr("name")==targets_zhuang?($("#target-zhuang-lb").text("胡"+player_names[targets_zhuang]+"二倍"),$("#target-zhuang-lb").show(),$(this).attr("name")+"*"):$(this).prop("checked")?$(this).attr("name"):void 0}).get().toString()})})}),$(document).ready(function(){wid=$(".player").width(),$(".player, .game-table").height(wid),$(".player, .game-table").css({"font-size":.7*wid}),$(".hu-label, .fan-btn").css({"min-width":"100px"}),player_key_list=$(".player").map(function(){return $(this).attr("id")});for(let e=0;e<player_key_list.length;e++)n=player_names[player_key_list[e]],$("#"+player_key_list[e]+"-name").text(n);$("#edit-btn").click(function(){class_str=$(".player-icon").attr("class"),class_str.includes("fa-user-circle")?($(".player-icon").removeClass("fa-user-circle"),$(".player-icon").addClass("fa-user-edit"),$("#edit-btn").text("完成"),$(".player").css({color:"#E59934"}),$(".player").map(function(){$(this).attr("data-bs-target","#changeNameModal")})):($(".player-icon").removeClass("fa-user-edit"),$(".player-icon").addClass("fa-user-circle"),$("#edit-btn").text("编辑玩家"),$(".player").css({color:"black"}),$(".player").map(function(){$(this).attr("data-bs-target","#recordModal")}))}),$("#player-name").change(function(){player_key=$(this).attr("id"),new_name=$(this).val()}),$("#player-name").click(function(){$(this).select()})}),$(document).on("input proportychange",".zhuang-check",function(){$("#target-zhuang-lb").text(""),$("#target-zhuang-lb").hide(),targets_zhuang=$(this).attr("key"),targets=$(".target-check").map(function(){return console.log($(this).attr("name")),$(this).prop("checked")&&$(this).attr("name")==targets_zhuang?($("#target-zhuang-lb").text("胡"+player_names[targets_zhuang]+"二倍"),$("#target-zhuang-lb").show(),$(this).attr("name")+"*"):$(this).prop("checked")?$(this).attr("name"):void 0}).get().toString()}),$(document).on("click","#btn-record",function(){""!=selected_player&&(saveRecord(),showHistory(history_record,fan_rules,id2chinese,settings),doneAndClear())}),$(document).on("click","#btn-gang",function(){""==gang_left||gang_right==[]||""==zhuang?showAlert("请选择"+(""==zhuang?"庄家":"对象")):(saveZhuangRecord(),showHistory(history_record,fan_rules,id2chinese,settings),doneAndClear())}),$(document).on("click",".swipe-menu",function(){$(this).parent().hasClass("swap-open")?$(".swap-item").removeClass("swap-open"):($(".swap-item").removeClass("swap-open"),$(this).parent().addClass("swap-open"))}),$(document).on("click",".swipe-right",function(){t=$(this).attr("id").split("-")[1],deleteOneHistoryByTime(history_record,t),saveRecord(),showHistory(history_record,fan_rules,id2chinese,settings),doneAndClear()}),$(document).on("click","#delete-btn",function(){deleteHistory(player_names),saveRecord(),overall_points={up:0,left:0,right:0,down:0};for(const e in overall_points)$("#"+e+"-score").text(overall_points[e])}),$(document).on("input proportychange","#limit-bar",function(){settings["max-limit"]=$(this).val(),$("#max-limit").text($(this).val()),saveSettings(),showHistory(history_record,fan_rules,id2chinese,settings),doneAndClear()});