function resetAllFan(){$("#target-zhuang-lb").text(""),$("#target-zhuang-lb").hide(),$("#fan-value").text(fan),$(".record-check").prop("checked",!1),$(".hu-check").map((function(){"hu"!=$(this).attr("id")?$(this).prop("checked",!1):$(this).prop("checked",!0)})),$("#zimo-value").text(zimo_fan),$("#zhuang-value").text(zhuang_fan),setTotalFan(recordModal,player_names,fan_rules,selected_player,fan)}function resetAll(){resetAllFan();for(const e in player_names)$("."+e+"-profile-image").css({"border-color":"#999"})}function doneAndClear(){selected_player="",new_name="",total_fan=0,hu_fan=1,fan=0,zhuang_fan=0,zimo_fan=0,qyj_fan=0,record="",targets="",targets_zhuang="",gang_left="",gang_right=[],gang_type=1,player_choose_list=[]}selected_player="",new_name="",total_fan=0,hu_fan=1,fan=0,zhuang_fan=0,zimo_fan=0,qyj_fan=0,fan_rules={hu:1,qys:3,ytl:3,ddh:2,qxd:3,dh:5,th:6,zimo:1,zhuang:1,qyj:1,mg:1,ag:2,jgd:3},id2chinese={th:"天胡",dh:"地胡",qxd:"七小对",ytl:"一条龙",qys:"清一色",ddh:"对对胡",hu:"小屁胡",zimo:"自摸",zhuang:"庄家",qyj:"去幺九",qyj:"去幺九",mg:"明杠",ag:"暗杠",jgd:"金钩钓"},record="",targets="",targets_zhuang="",gang_left="",gang_right=[],zhuang="down",gang_type=1,player_choose_list=[],g_last_record_time=-1,player_indices={up:"1",left:"2",right:"3",down:"4"},player_names={up:"上",left:"左",right:"右",down:"下"};var array,names=localStorage.getItem("names");function setFan(e){fan=e,$("#fan-value").text(fan)}function setHuFan(e,t){hu_fan=0,t.forEach((t=>{hu_fan+=e[t]}))}function setZimoFan(e){zimo_fan=e,$("#zimo-value").text(zimo_fan)}function setZhuangFan(e){zhuang_fan=e,$("#zhuang-value").text(zhuang_fan)}function setQyjFan(e){qyj_fan=e,$("#qyj-value").text(qyj_fan)}function setTotalFan(e,t,a,n,r){total_fan=r,record="",zhuang==n?($("#zhuang-lb").show(),total_fan+=a.zhuang,record+="zhuang,"):$("#zhuang-lb").hide(),$(".hu-check").map((function(){$(this).prop("checked")?($("#"+$(this).attr("id")+"-lb").show(),record+=$(this).attr("id")+",",total_fan+=a[$(this).attr("id")]):$("#"+$(this).attr("id")+"-lb").hide()})),e.querySelector(".modal-title").textContent="为 "+t[n]+"记分, 合计："+total_fan+"番"}function saveRecord(){""!=record?(time_now=Date.now(),targets.split(",").forEach((e=>{""!=e&&history_record.push(e+":"+time_now+":"+record+":"+selected_player+":-:"+fan)})),history_record.push(selected_player+":"+time_now+":"+record+":"+targets+":+:"+fan),localStorage.setItem("history",JSON.stringify(history_record))):localStorage.setItem("history",JSON.stringify(history_record))}function saveZhuangRecord(){if(!(player_choose_list.length<=1)){record=1==gang_type?"mg,":"ag,",time_now=Date.now(),player_choose_list[0]==zhuang&&(record+="zhuang,");var e=player_choose_list[0];for(let t=1;t<player_choose_list.length;t++){let a=player_choose_list[t];a==zhuang&&(a+="*"),history_record.push(a+":"+time_now+":"+record+":"+e+":-:0")}targets="";for(let e=1;e<player_choose_list.length;e++){let t=player_choose_list[e];t==zhuang?targets+=t+"*,":targets+=t+","}history_record.push(e+":"+time_now+":"+record+":"+targets+":+:0"),localStorage.setItem("history",JSON.stringify(history_record))}}function setZhuangByInd(e){let t=1;for(const a in player_names)t==e?(zhuang=a,$("."+a+"-profile-image").css({background:"#E59934"}),$("."+a+"-profile-image").css({"border-color":"#E59934"})):($("."+a+"-profile-image").css({background:"#512DA8"}),$("."+a+"-profile-image").css({"border-color":"#512DA8"})),t++;$("#choose-zhuang").text(player_names[zhuang]),new_record_time=Date.now(),console.log("Since last set zhuang: "+(new_record_time-g_last_record_time)/1e3+" seconds"),g_last_record_time=new_record_time}function saveSettings(){localStorage.setItem("settings",JSON.stringify(settings))}null!==names&&(player_names=JSON.parse(names),localStorage.setItem("names",JSON.stringify(player_names))),history_record=[],null!==(array=localStorage.getItem("history"))&&(history_record=JSON.parse(array),Array.isArray(history_record)||(history_record=[]),localStorage.setItem("history",JSON.stringify(history_record))),settings={"max-limit":8},null!==(array=localStorage.getItem("settings"))&&(settings=JSON.parse(array),localStorage.setItem("settings",JSON.stringify(settings))),showMaxLimit(settings["max-limit"]),showHistory(history_record,fan_rules,id2chinese,settings);var changeNameModal=document.getElementById("changeNameModal");changeNameModal.addEventListener("show.bs.modal",(function(e){var t=e.relatedTarget,a=player_names[t.getAttribute("id")],n=changeNameModal.querySelector(".modal-title"),r=changeNameModal.querySelector(".modal-body input");n.textContent="为 “"+a+"” 更改昵称",r.value=a,selected_player=$(t).attr("id")}));var recordModal=document.getElementById("recordModal");function showAlert(e){$("#alert-msg").text(e),$("#alertModal").addClass("show"),$("#alertModal").css({display:"block"})}function closeAlert(){$("#alertModal").removeClass("show"),$("#alertModal").css({display:"none"})}function showProfileImage(){for(const e in player_names){if(fields=player_names[e].split(" "),fields.length<=1&&player_names[e].length<=3)initials=player_names[e];else{initials="";for(let e=0;e<fields.length&&3!=e;e++)initials+=fields[e].charAt(0)}$("."+e+"-profile-image").text(initials)}}function setupPlayerChoose(){targets="",$("#target-zhuang-lb").hide();for(const e in player_names)player_choose_list.includes(e)?0==player_choose_list.indexOf(e)?$("."+e+"-profile-image").css({"border-color":"#1F6650"}):($("."+e+"-profile-image").css({"border-color":"#EA5E5E"}),e==zhuang?($("#target-zhuang-lb").text("胡"+player_names[zhuang]+"二倍"),$("#target-zhuang-lb").show(),targets+=e+"*,"):targets+=e+","):$("."+e+"-profile-image").css({"border-color":"#999"})}recordModal.addEventListener("show.bs.modal",(function(e){var t=e.relatedTarget;selected_player=$(t).attr("id"),setTotalFan(recordModal,player_names,fan_rules,selected_player,fan)})),$(document).ready((function(){wid=$(".player").width(),$(".player, .game-table").height(wid),$(".player, .game-table").css({"font-size":.7*wid}),showProfileImage(),$(".player-icon, .player-name").css({display:"none"}),$(".hu-label, .fan-btn").css({"min-width":"100px"}),$("#choose-zhuang").text(player_names.down),$("#zhuang-choice-up").text(player_names.up),$("#zhuang-choice-left").text(player_names.left),$("#zhuang-choice-right").text(player_names.right),$("#zhuang-choice-down").text(player_names.down),$("#zhuang-bar").val(4),$(".down-profile-image").css({background:"#E59934"}),$(".down-profile-image").css({"border-color":"#E59934"}),player_key_list=$(".player").map((function(){return $(this).attr("id")}));for(let e=0;e<player_key_list.length;e++)n=player_names[player_key_list[e]],$("#"+player_key_list[e]+"-name").text(n);$("#edit-btn").click((function(){class_str=$(".player-icon").attr("class"),"none"==$(".player-icon").css("display")?($(".player-icon, .player-name").css({display:"block"}),$(".profile-image").css({display:"none"}),$("#edit-btn").text("完成"),$(".player-icon").css({color:"#D06224"}),$(".player").map((function(){$(this).attr("data-bs-target","#changeNameModal")}))):($(".player-icon, .player-name").css({display:"none"}),$("#edit-btn").text("编辑玩家"),$(".player-icon").css({color:"black"}),$(".player").map((function(){$(this).attr("data-bs-target","#recordModal")})),showProfileImage())})),$("#player-name").change((function(){player_key=$(this).attr("id"),new_name=$(this).val()})),$("#player-name").click((function(){$(this).select()}))})),$(document).ready((function(){$("#btn-change-name").click((function(){""!=selected_player&&(player_names[selected_player]=$("#player-name").val(),$("#"+selected_player+"-name").text(player_names[selected_player]),saveNames(player_names))})),$(".alert-close").click((function(){closeAlert()})),$(".hu-check, .zhuang-check").on("input proportychange",(function(){""==targets&&showAlert("请先选胡谁！"),hu_checked=$(".hu-check, #hu").prop("checked"),bigger_hu_checked="hu"!=$(this).attr("id")&&$(this).hasClass("hu-type"),"ddh"==$(this).attr("id")&&$(this).prop("checked")&&$("#jgd").prop("checked",!1),"jgd"==$(this).attr("id")&&$(this).prop("checked")&&$("#ddh").prop("checked",!1),hu_checked&&"hu"==$(this).attr("id")&&$(".hu-check").map((function(){"hu"!=$(this).attr("id")&&$(this).prop("checked",!1)})),bigger_hu_checked&&$("#hu").prop("checked",!1),hu_list=$(".hu-check").map((function(){if($(this).prop("checked"))return $(this).attr("id")})).get(),setHuFan(fan_rules,hu_list),setTotalFan(recordModal,player_names,fan_rules,selected_player,fan)})),$(".fan-btn").click((function(){"minus-fan"==$(this).attr("name")?(fan--,fan<0&&(fan=0)):fan++,setFan(fan),setTotalFan(recordModal,player_names,fan_rules,selected_player,fan)})),$("#zimo").on("input proportychange",(function(){v=$(this).prop("checked")?1:0,setZimoFan(v),setTotalFan(recordModal,player_names,fan_rules,selected_player,fan)})),$("#zhuang").on("input proportychange",(function(){v=$(this).prop("checked")?1:0,1==v&&($("#target-zhuang-lb").text(""),$("#target-zhuang-lb").hide()),setZhuangFan(v),setTotalFan(recordModal,player_names,fan_rules,selected_player,fan)})),$("#qyj").on("input proportychange",(function(){v=$(this).prop("checked")?1:0,setQyjFan(v),setTotalFan(recordModal,player_names,fan_rules,selected_player,fan)})),$(".gang-btn").click((function(){"mg-btn"==$(this).attr("id")?($("#gangModalLabel").text("明杠"),gang_type=1):"ag-btn"==$(this).attr("id")&&($("#gangModalLabel").text("暗杠"),gang_type=2)})),$(".player").click((function(){doneAndClear(),resetAll(),selected_player=$(this).attr("id"),player_choose_list.push(selected_player),setupPlayerChoose(),"none"==$(".player-icon").css("display")?(setZhuangFan(selected_player==zhuang?1:0),setTotalFan(recordModal,player_names,fan_rules,selected_player,fan)):(new_name="",$("#player-name").val(new_name),$("#player-name").focus())})),$(".player-choose").click((function(){if(this_player=$(this).attr("player-id"),selected_player!=this_player)if(player_choose_list.includes(this_player)){var e=player_choose_list.indexOf(this_player);-1!==e&&player_choose_list.splice(e,1)}else player_choose_list.push(this_player);setupPlayerChoose()}))})),$(document).on("input proportychange",".zhuang-check",(function(){$("#target-zhuang-lb").text(""),$("#target-zhuang-lb").hide(),targets_zhuang=$(this).attr("key"),targets=$(".target-check").map((function(){return $(this).prop("checked")&&$(this).attr("name")==targets_zhuang?($("#target-zhuang-lb").text("胡"+player_names[targets_zhuang]+"二倍"),$("#target-zhuang-lb").show(),$(this).attr("name")+"*"):$(this).prop("checked")?$(this).attr("name"):void 0})).get().toString()})),$(document).on("click","#btn-record",(function(){if(""!=selected_player){const e=document.getElementById("liveAlertPlaceholder"),t=(t,a)=>{const n=document.createElement("div");n.innerHTML=[`<div class="alert alert-${a} alert-dismissible" role="alert">`,`   <div>${t}</div>`,'   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',"</div>"].join(""),e.append(n)};saveRecord(),new_record_time=Date.now(),TIMEOUT_TO_NEW_ZHUANG=90,(new_record_time-g_last_record_time)/1e3>TIMEOUT_TO_NEW_ZHUANG&&(player_ind=player_indices[selected_player],setZhuangByInd(player_ind),t("庄家被重置为："+player_names[selected_player],"warning")),showHistory(history_record,fan_rules,id2chinese,settings),doneAndClear(),resetAll()}})),$(document).on("click",".btn-cancel",(function(){doneAndClear(),resetAll()})),$(document).on("click","#btn-gang",(function(){saveZhuangRecord(),showHistory(history_record,fan_rules,id2chinese,settings),doneAndClear(),resetAll()})),$(document).on("click",".swipe-menu",(function(){$(this).parent().hasClass("swap-open")?$(".swap-item").removeClass("swap-open"):($(".swap-item").removeClass("swap-open"),$(this).parent().addClass("swap-open"))})),$(document).on("click",".swipe-right",(function(){t=$(this).attr("id").split("-")[1],deleteOneHistoryByTime(history_record,t),showHistory(history_record,fan_rules,id2chinese,settings),doneAndClear(),saveRecord()})),$(document).on("click","#delete-btn",(function(){deleteHistory(player_names),doneAndClear(),saveRecord(),overall_points={up:0,left:0,right:0,down:0};for(const e in overall_points)$("#"+e+"-score").text(overall_points[e])})),$(document).on("input proportychange","#limit-bar",(function(){settings["max-limit"]=$(this).val(),$("#max-limit").text($(this).val()),saveSettings(),showHistory(history_record,fan_rules,id2chinese,settings),doneAndClear()})),$(document).on("input proportychange","#zhuang-select-bar",(function(){setZhuangByInd($(this).val())}));